// Prisma schema for Fieldly PIM

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model User {
  id             String   @id @default(uuid())
  email          String?  @unique
  password       String
  name           String
  phone          String?  @unique
  farmName       String
  profilePicture String?
  refreshToken   String?
  otp            String?
  otpExpiresAt   DateTime?
  fields         Field[]
  missions       Mission[]
  conversations  Conversation[]
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  @@map("users")
}

model Field {
  id               String   @id @default(uuid())
  userId           String
  user             User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  name             String
  cropType         String?
  areaCoordinates  Json     // [[lat, lng], [lat, lng], ...]
  areaSize         Float?   // in square meters
  missions         Mission[]
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  @@map("fields")
  @@index([userId])
}

model Mission {
  id              String   @id @default(uuid())
  userId          String
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  fieldId         String
  field           Field    @relation(fields: [fieldId], references: [id], onDelete: Cascade)
  title           String
  description     String?
  missionType     String   // PLANTING, HARVESTING, IRRIGATION, FERTILIZING, PEST_CONTROL, MAINTENANCE, MONITORING, OTHER
  status          String   @default("PENDING") // PENDING, IN_PROGRESS, COMPLETED, CANCELLED
  priority        String   @default("MEDIUM") // LOW, MEDIUM, HIGH, URGENT
  dueDate         DateTime?
  assignedDate    DateTime @default(now())
  completedAt     DateTime?
  estimatedDuration Int?   // in hours
  actualDuration  Int?     // in hours
  progress        Int      @default(0) // 0-100
  notes           String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@map("missions")
  @@index([userId])
  @@index([fieldId])
}
model Conversation {
  id        String   @id @default(uuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  title     String   @default("New Conversation")
  messages  ChatMessage[]
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("conversations")
  @@index([userId])
}

model ChatMessage {
  id             String   @id @default(uuid())
  conversationId String
  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  role           String   // "user" or "assistant"
  content        String   @db.Text
  createdAt      DateTime @default(now())

  @@map("chat_messages")
  @@index([conversationId])
}